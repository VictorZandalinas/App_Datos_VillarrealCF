name: Deploy Villarreal App
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: 154.56.153.161
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /root/App_Datos_VillarrealCF
            # Configuramos git para evitar errores de identidad
            git config user.email "servidor@villarreal.com"
            git config user.name "Servidor Villarreal"
            
            # 1. Guardar cambios de datos generados en el servidor antes de bajar el código nuevo
            git add .
            git commit -m "Auto-save data before deploy [skip ci]" || echo "No hay cambios en datos"
            
            # 2. Bajar el código nuevo de GitHub
            git pull origin main
            
            # 3. Instalar librerías si has añadido alguna nueva
            pip install -r requirements.txt
            
            # 4. Crear directorios de jobs si no existen
            mkdir -p /root/App_Datos_VillarrealCF/jobs/{pending,processing,completed,failed}
            mkdir -p /root/App_Datos_VillarrealCF/informes_generados

            # 5. Configurar worker service si no existe
            if [ ! -f /etc/systemd/system/villarreal-worker.service ]; then
              cp villarreal-worker.service /etc/systemd/system/
              systemctl daemon-reload
              systemctl enable villarreal-worker.service
            fi

            # 6. Reiniciar los servicios
            systemctl restart villarreal.service
            systemctl restart villarreal-worker.service